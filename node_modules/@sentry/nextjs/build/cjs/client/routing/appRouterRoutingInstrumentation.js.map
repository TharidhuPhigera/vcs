{"version":3,"file":"appRouterRoutingInstrumentation.js","sources":["../../../../src/client/routing/appRouterRoutingInstrumentation.ts"],"sourcesContent":["import {\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n} from '@sentry/core';\nimport { GLOBAL_OBJ, browserPerformanceTimeOrigin } from '@sentry/core';\nimport type { Client, Span } from '@sentry/core';\nimport { WINDOW, startBrowserTracingNavigationSpan, startBrowserTracingPageLoadSpan } from '@sentry/react';\n\nexport const INCOMPLETE_APP_ROUTER_INSTRUMENTATION_TRANSACTION_NAME = 'incomplete-app-router-transaction';\n\n/** Instruments the Next.js app router for pageloads. */\nexport function appRouterInstrumentPageLoad(client: Client): void {\n  const origin = browserPerformanceTimeOrigin();\n  startBrowserTracingPageLoadSpan(client, {\n    name: WINDOW.location.pathname,\n    // pageload should always start at timeOrigin (and needs to be in s, not ms)\n    startTime: origin ? origin / 1000 : undefined,\n    attributes: {\n      [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'pageload',\n      [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.pageload.nextjs.app_router_instrumentation',\n      [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n    },\n  });\n}\n\ninterface NavigationSpanRef {\n  current: Span | undefined;\n}\n\ninterface NextRouter {\n  back: () => void;\n  forward: () => void;\n  push: (target: string) => void;\n  replace: (target: string) => void;\n}\n\n// Yes, yes, I know we shouldn't depend on these internals. But that's where we are at. We write the ugly code, so you don't have to.\nconst GLOBAL_OBJ_WITH_NEXT_ROUTER = GLOBAL_OBJ as typeof GLOBAL_OBJ & {\n  // Available until 13.4.4-canary.3 - https://github.com/vercel/next.js/pull/50210\n  nd?: {\n    router?: NextRouter;\n  };\n  // Available from 13.4.4-canary.4 - https://github.com/vercel/next.js/pull/50210\n  next?: {\n    router?: NextRouter;\n  };\n};\n\n/*\n * The routing instrumentation needs to handle a few cases:\n * - Router operations:\n *  - router.push() (either explicitly called or implicitly through <Link /> tags)\n *  - router.replace() (either explicitly called or implicitly through <Link replace /> tags)\n *  - router.back()\n *  - router.forward()\n * - Browser operations:\n *  - native Browser-back / popstate event (implicitly called by router.back())\n *  - native Browser-forward / popstate event (implicitly called by router.forward())\n */\n\n/** Instruments the Next.js app router for navigation. */\nexport function appRouterInstrumentNavigation(client: Client): void {\n  const currentNavigationSpanRef: NavigationSpanRef = { current: undefined };\n\n  WINDOW.addEventListener('popstate', () => {\n    if (currentNavigationSpanRef.current?.isRecording()) {\n      currentNavigationSpanRef.current.updateName(WINDOW.location.pathname);\n      currentNavigationSpanRef.current.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_SOURCE, 'url');\n    } else {\n      currentNavigationSpanRef.current = startBrowserTracingNavigationSpan(client, {\n        name: WINDOW.location.pathname,\n        attributes: {\n          [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'navigation',\n          [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.navigation.nextjs.app_router_instrumentation',\n          [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n          'navigation.type': 'browser.popstate',\n        },\n      });\n    }\n  });\n\n  let routerPatched = false;\n  let triesToFindRouter = 0;\n  const MAX_TRIES_TO_FIND_ROUTER = 500;\n  const ROUTER_AVAILABILITY_CHECK_INTERVAL_MS = 20;\n  const checkForRouterAvailabilityInterval = setInterval(() => {\n    triesToFindRouter++;\n    const router = GLOBAL_OBJ_WITH_NEXT_ROUTER?.next?.router ?? GLOBAL_OBJ_WITH_NEXT_ROUTER?.nd?.router;\n\n    if (routerPatched || triesToFindRouter > MAX_TRIES_TO_FIND_ROUTER) {\n      clearInterval(checkForRouterAvailabilityInterval);\n    } else if (router) {\n      clearInterval(checkForRouterAvailabilityInterval);\n      routerPatched = true;\n\n      patchRouter(client, router, currentNavigationSpanRef);\n\n      // If the router at any point gets overridden - patch again\n      (['nd', 'next'] as const).forEach(globalValueName => {\n        const globalValue = GLOBAL_OBJ_WITH_NEXT_ROUTER[globalValueName];\n        if (globalValue) {\n          GLOBAL_OBJ_WITH_NEXT_ROUTER[globalValueName] = new Proxy(globalValue, {\n            set(target, p, newValue) {\n              if (p === 'router' && typeof newValue === 'object' && newValue !== null) {\n                patchRouter(client, newValue, currentNavigationSpanRef);\n              }\n\n              // @ts-expect-error we cannot possibly type this\n              target[p] = newValue;\n              return true;\n            },\n          });\n        }\n      });\n    }\n  }, ROUTER_AVAILABILITY_CHECK_INTERVAL_MS);\n}\n\nfunction transactionNameifyRouterArgument(target: string): string {\n  try {\n    // We provide an arbitrary base because we only care about the pathname and it makes URL parsing more resilient.\n    return new URL(target, 'http://example.com/').pathname;\n  } catch {\n    return '/';\n  }\n}\n\nconst patchedRouters = new WeakSet<NextRouter>();\n\nfunction patchRouter(client: Client, router: NextRouter, currentNavigationSpanRef: NavigationSpanRef): void {\n  if (patchedRouters.has(router)) {\n    return;\n  }\n  patchedRouters.add(router);\n\n  (['back', 'forward', 'push', 'replace'] as const).forEach(routerFunctionName => {\n    if (router?.[routerFunctionName]) {\n      // @ts-expect-error Weird type error related to not knowing how to associate return values with the individual functions - we can just ignore\n      router[routerFunctionName] = new Proxy(router[routerFunctionName], {\n        apply(target, thisArg, argArray) {\n          let transactionName = INCOMPLETE_APP_ROUTER_INSTRUMENTATION_TRANSACTION_NAME;\n          const transactionAttributes: Record<string, string> = {\n            [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'navigation',\n            [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.navigation.nextjs.app_router_instrumentation',\n            [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n          };\n\n          if (routerFunctionName === 'push') {\n            transactionName = transactionNameifyRouterArgument(argArray[0]);\n            transactionAttributes[SEMANTIC_ATTRIBUTE_SENTRY_SOURCE] = 'url';\n            transactionAttributes['navigation.type'] = 'router.push';\n          } else if (routerFunctionName === 'replace') {\n            transactionName = transactionNameifyRouterArgument(argArray[0]);\n            transactionAttributes[SEMANTIC_ATTRIBUTE_SENTRY_SOURCE] = 'url';\n            transactionAttributes['navigation.type'] = 'router.replace';\n          } else if (routerFunctionName === 'back') {\n            transactionAttributes['navigation.type'] = 'router.back';\n          } else if (routerFunctionName === 'forward') {\n            transactionAttributes['navigation.type'] = 'router.forward';\n          }\n\n          currentNavigationSpanRef.current = startBrowserTracingNavigationSpan(client, {\n            name: transactionName,\n            attributes: transactionAttributes,\n          });\n\n          return target.apply(thisArg, argArray);\n        },\n      });\n    }\n  });\n}\n"],"names":["browserPerformanceTimeOrigin","startBrowserTracingPageLoadSpan","WINDOW","SEMANTIC_ATTRIBUTE_SENTRY_OP","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","SEMANTIC_ATTRIBUTE_SENTRY_SOURCE","GLOBAL_OBJ","startBrowserTracingNavigationSpan"],"mappings":"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"}